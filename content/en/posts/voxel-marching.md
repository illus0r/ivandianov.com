---
title: Воксельный реймаршинг
date: 2023-02-18
progress: 1
---


План того, что тут будет появляться:

- Классический воксель-маршинг
- Гибридный, с СДФ внутри вокселей
- Ускорение с помощью мипмэпа
- Ускорение с помощью джамп-флуда

Предполагаю, что вы уже знакомы с алгоритмом реймаршинга, если нет, [посмотрите видео](https://www.youtube.com/watch?v=PGtv-dBi2wE)

## Классический воксель-маршинг

В отличие от реймаршинга, в котором длина шага зависит от расстояния до ближайшего объекта, тут пространство делится на кубические ячейки, как тетрадь в клетку. И каждый шаг вдоль луча происходит от вокселя к вокселю. Шагнув в воксель мы проверяем, полный он или пустой. И если полный — останавливаемся, мы уткнулись в объект, можно дальше не маршировать.

Чтобы разобраться, как работает трёхмерный воксель-маршинг, лучше начать с двумерного. А круче всего — вообще с одномерного.

Вот оно, наше двумерное пространство. Мы пустим луч из точки 0, пусть камера будет там. Луч полетит вправо, будет лететь, пока не найдёт заполненный ~~воксель~~ отрезок.


<iframe src="https://editor.p5js.org/illus0r/full/_Ln1BsDwd" width=400 height=444></iframe>

Недописанный скетч для 2д случая {: .caption}


## Ускорение с помощью SDF-текстуры

Более простой и, кажется, более надёжный способ — заранее сделать карту вокселей. Каждый пустой воксель в ней будет знать расстояние до ближайшего не пустого.

Посчитать можно с помощью [джамп-флудинга](https://t.me/ivandianov/487).

Если раньше мы двигались по лучу не дальше, чем на один воксель, теперь можем проверять SDF текстуру и, если до ближайшего вокселя далеко, шагать смелее.

Например, у этой картинки

![](/assets/media/2023-02-23-20-25-01.jpg)

вот такой СДФ:

<video controls muted loop autoplay><source src="/assets/media/voxel-marching-sdf.mp4" type="video/mp4"></video>

На самом деле я использую 2д текстуру для его хранения. Чтобы это получилось, я разрезаю объёмную карту на горизонтальные слои в один воксель и кладу их слева направо. Получается текстура высотой voxSize и шириной voxSize²

![](/assets/media/2023-02-23-21-02-58.png)
Это не `<hr>`, это узкая картинка{: .caption}

Как видите, вы почти ничего не видите. Слишком мелко. Если призумить кусочек, будет так:

![](/assets/media/2023-02-23-21-04-28.png)
